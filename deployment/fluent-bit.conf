# Fluent Bit configuration for log aggregation
# Optimized for enhanced image processing API

[SERVICE]
    Flush         5
    Daemon        off
    Log_Level     info
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# API application logs
[INPUT]
    Name              tail
    Path              /var/log/api/*.log
    Parser            json
    Tag               api.*
    Refresh_Interval  5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Skip_Empty_Lines  On

# Nginx access logs
[INPUT]
    Name              tail
    Path              /var/log/nginx/access.log
    Parser            nginx_access
    Tag               nginx.access
    Refresh_Interval  5
    Mem_Buf_Limit     20MB

# Nginx error logs
[INPUT]
    Name              tail
    Path              /var/log/nginx/error.log
    Parser            nginx_error
    Tag               nginx.error
    Refresh_Interval  5
    Mem_Buf_Limit     10MB

# Docker container logs
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Tag               docker.*
    Refresh_Interval  10
    Mem_Buf_Limit     30MB
    Skip_Long_Lines   On

# System metrics
[INPUT]
    Name            cpu
    Tag             system.cpu
    Interval_Sec    30

[INPUT]
    Name            mem
    Tag             system.memory
    Interval_Sec    30

[INPUT]
    Name            disk
    Tag             system.disk
    Interval_Sec    60
    Interval_NSec   0

# Performance optimization logs filter
[FILTER]
    Name                parser
    Match               api.*
    Key_Name            message
    Parser              performance_log
    Reserve_Data        On
    Preserve_Key        On

# Add environment and service metadata
[FILTER]
    Name                modify
    Match               *
    Add                 environment production
    Add                 service rethinking-park-api
    Add                 version 1.0.0

# Performance metrics extraction
[FILTER]
    Name                grep
    Match               api.*
    Regex               level (INFO|WARN|ERROR)

# Error log highlighting
[FILTER]
    Name                modify
    Match               *.error
    Add                 severity error
    Add                 alert_required true

# Rate limiting for high-volume logs
[FILTER]
    Name                throttle
    Match               nginx.access
    Rate                1000
    Window              60
    Interval            1s

# Log routing and output

# Send error logs to alerting system
[OUTPUT]
    Name                http
    Match               *.error
    Host                your-alerting-service.com
    Port                443
    URI                 /api/v1/alerts
    Format              json
    tls                 On
    tls.verify          On
    Header              Authorization Bearer your-api-token

# Send performance metrics to monitoring
[OUTPUT]
    Name                http
    Match               api.performance
    Host                your-monitoring-service.com
    Port                443
    URI                 /api/v1/metrics
    Format              json
    tls                 On
    tls.verify          On
    Header              Authorization Bearer your-metrics-token

# Send all logs to centralized logging (optional)
[OUTPUT]
    Name                forward
    Match               *
    Host                your-log-aggregator.com
    Port                24224
    Shared_Key          your-shared-key
    Self_Hostname       rethinking-park-api-prod

# Local file output for debugging
[OUTPUT]
    Name                file
    Match               api.*
    Path                /var/log/fluent-bit/
    File                api-processed.log
    Format              json_lines

# Console output for development
[OUTPUT]
    Name                stdout
    Match               system.*
    Format              json_lines